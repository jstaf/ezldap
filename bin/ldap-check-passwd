#!/usr/bin/env python3

import sys
import argparse
import getpass
import ezldap

def main():
    parser = argparse.ArgumentParser(
            description='Verify that an LDAP password is correct. '
                        'Currently only works with SSHA-encrypted passwords.')
    parser.add_argument('USERNAME', nargs='?', type=str, 
            help='If a username is supplied, this will check that user\'s password. ' 
            'You will otherwise be prompted for the password hash.')
    argv = parser.parse_args()

    if argv.USERNAME is None:
        print('Enter SSHA password hash...')
        ssha = getpass.getpass()
    else:
        with ezldap.auto_bind() as con:
            query = con.get_user(argv.USERNAME)
            if len(query) != 1:
                sys.exit('User not found.')

            ssha = ezldap.get_attrib_list(query, 'userPassword')[0]

    print('\nEnter password to verify...')
    passwd = getpass.getpass()

    if ezldap.ssha_check(ssha, passwd):
        print('\nPasswords match!')
    else:
        print('\nPasswords do not match. :\'(')


if __name__ == '__main__':
    main()
