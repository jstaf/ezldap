#!/usr/bin/env python3

import argparse
import ezldap

def main():
    parser = argparse.ArgumentParser(description=
            "Creates an LDAP user and add to a group. " 
            "Creates a same-named LDAP group as well if no group specified."
            "Prints the randomly generated password to stdout.")
    parser.add_argument('username', nargs=1, type=str,
            help="Username to create.")
    parser.add_argument('groupname', nargs='?', type=str,
            help="Groupname to add user to. If omitted, creates same-named LDAP group.")
    parser.add_argument('-n', '--dry-run', default=False, 
            const=True, action='store_const')
    argv = parser.parse_args()
    user = argv.username[0]
    group = argv.groupname

    with ezldap.auto_bind() as con:
        if group is None:
            # create a new group
            group = user
            con.add_group(group)

        passwd = ezldap.random_passwd()
        print('# Password for {} is: {}'.format(user, passwd))

        con.add_user(user, group, passwd)
        con.add_user_to_group(user, group)

if __name__ == '__main__':
    main()
