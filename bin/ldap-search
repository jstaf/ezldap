#!/usr/bin/env python3

import argparse
import ldap
import ezldap

def main():
    parser = argparse.ArgumentParser(description='Search LDAP tree for a DN keyword and print resulting LDIF.')
    parser.add_argument('keyword', nargs='?', type=str, default='', 
            help='Keyword to search DNs by (case-sensitive). Dumps entire directory if not supplied.')
    argv = parser.parse_args()
    key = argv.keyword

    with ezldap.auto_bind() as con:
        base_dn = con.base_dn()
        # retrieves everything... 
        # might not work against huge LDAP directories due to paging limits
        query = con.search_s(base_dn, ldap.SCOPE_SUBTREE)
        
        # grab all objects with our search key in the DN
        results = [entry for entry in query if key in entry[0]]
        
        # dump results to ldif
        ldif = ezldap.LDIF()
        ldif.populate(results)
        ldif.write()


if __name__ == '__main__':
    main()
